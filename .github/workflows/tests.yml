name: Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json
      - name: Install version tooling
        run: npm ci
      - name: Determine build version
        run: |
          current_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          if [ -z "$current_tag" ]; then
            version="dev"
          else
            version="$(node scripts/get-next-version.js)"
          fi
          echo "VERSION=$version" >> "$GITHUB_ENV"
          echo "Version: $version" >> "$GITHUB_STEP_SUMMARY"
      - name: Go tests
        run: go test ./...
      - name: Frontend tests
        working-directory: frontend
        run: |
          npm ci
          npm run test:coverage
